



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Dead letter pattern for this solution - Container Shipment EDA reference implementation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-149377589-3", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#dead-letter-queue-pattern" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Container Shipment EDA reference implementation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Container Shipment EDA reference implementation
            </span>
            <span class="md-header-nav__topic">
              Dead letter pattern for this solution
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Container Shipment EDA reference implementation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Container Shipment EDA reference implementation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Business problem statement
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Business problem statement
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../analysis/readme/" title="Event storming analysis" class="md-nav__link">
      Event storming analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/readme/" title="From Analysis to Microservice Specifications" class="md-nav__link">
      From Analysis to Microservice Specifications
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Development practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-order-ms" title="Order microservice with CQRS and Event Sourcing" class="md-nav__link">
      Order microservice with CQRS and Event Sourcing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/springboot" title="Container microservice with Springboot - Spring Kafka and PostgreSQL" class="md-nav__link">
      Container microservice with Springboot - Spring Kafka and PostgreSQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../avro/avro/" title="Adopting Schema Registry and Avro" class="md-nav__link">
      Adopting Schema Registry and Avro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../saga/saga/" title="Saga applied to container solution" class="md-nav__link">
      Saga applied to container solution
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Dead letter pattern for this solution
      </label>
    
    <a href="./" title="Dead letter pattern for this solution" class="md-nav__link md-nav__link--active">
      Dead letter pattern for this solution
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementation" title="Implementation" class="md-nav__link">
    Implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-unavailable" title="Service Unavailable" class="md-nav__link">
    Service Unavailable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errors" title="Errors" class="md-nav__link">
    Errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-to-do-next" title="What to do next" class="md-nav__link">
    What to do next
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../rejection/rejection/" title="Order rejection principle" class="md-nav__link">
      Order rejection principle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../containerAnomaly/containerAnomaly/" title="Container anomaly" class="md-nav__link">
      Container anomaly
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../deployments/reposlist/" title="Related repositories" class="md-nav__link">
      Related repositories
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/backing-services/" title="Backing Services" class="md-nav__link">
      Backing Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/application-components/" title="Application Components" class="md-nav__link">
      Application Components
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../security/" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Integration tests
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Integration tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/itgtests/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/happy-path/happy_path/" title="Happy Path" class="md-nav__link">
      Happy Path
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/saga/saga/" title="Saga Pattern" class="md-nav__link">
      Saga Pattern
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/order-rejected/order_rejected/" title="Order rejection" class="md-nav__link">
      Order rejection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/dlq/dlq/" title="Dead letter" class="md-nav__link">
      Dead letter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/containerAnomaly/containerAnomaly/" title="Container Anomaly" class="md-nav__link">
      Container Anomaly
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../demo/readme/" title="Demonstration script" class="md-nav__link">
      Demonstration script
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementation" title="Implementation" class="md-nav__link">
    Implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-unavailable" title="Service Unavailable" class="md-nav__link">
    Service Unavailable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errors" title="Errors" class="md-nav__link">
    Errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-to-do-next" title="What to do next" class="md-nav__link">
    What to do next
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc/edit/master/docs/dlq/dlq.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="dead-letter-queue-pattern">Dead Letter Queue Pattern</h1>
<p>In distributed systems, it is common to find mechanisms for retrying calls to other, potentially external, services and fail gracefully if that service is unavailable for any reason. Here we are going to talk about using non-blocking request reprocessing and dead letter queues (DLQ) to achieve decoupled, observable error-handling without disrupting real-time traffic in the context of the <a href="../../containerAnomaly/containerAnomaly/">Container Anomaly Use Case</a> of our Reefer Container Reference Application.</p>
<p>A brief description about the problem and how non-blocking reprocessing and dead letter queues can help us can be found <a href="https://ibm-cloud-architecture.github.io/refarch-eda/design-patterns/ED-patterns/#event-reprocessing-with-dead-letter-pattern">here</a>.</p>
<h2 id="implementation">Implementation</h2>
<p>As explained in the <a href="../../containerAnomaly/containerAnomaly/">Container Anomaly Use Case</a> of our Reefer Container Reference Application, the Spring Containers component calls a BPM process in order to get a field engineer assigned to checking and fixing a potentially bad container based on the telemetry events being sent by it.</p>
<p>As said in the introduction above, this call to the BPM process might fail so we need to implement a mechanism whereby we use non-blocking request reprocessing and dead letter queues (DLQ) to achieve decoupled, observable error-handling without disrupting real-time traffic.</p>
<p>We have done so by creating two new topics the Spring Container component will subscribe and publish to: <strong>container-anomaly-retry</strong> and <strong>container-anomaly-dead</strong>.</p>
<p>When the Spring Container receives a <strong>ContainerAnomaly</strong> event (actually three of these to decrease the load on the BPM side), it will call the BPM service. This call is divided into two actions:</p>
<ol>
<li><strong>Authenticate</strong> against BPM which will give you a token to</li>
<li><strong>Call the BPM process</strong> that will trigger the field engineer assignment process.</li>
</ol>
<p>Another important thing to have in mind when implementing retry and graceful failure mechanisms is that it only makes sense to retry a call to a, potentially external, service when this service is temporarily unavailable (because it is temporarily overloaded, temporarily down, etc) and not when the call failed (due to bad data sent, bad url used, etc). This way we avoid extra load in the dependent service by not retrying calls we know that will fail again anyway beforehand.</p>
<p>To illustrate this, we have decided that any failure in authenticating with BPM is an error and that it does not make sense to retry since it will fail again due to bad Spring Container component configuration (wrong BPM credentials provided).</p>
<h3 id="service-unavailable">Service Unavailable</h3>
<p><img alt="retry" src="../images/Slide1.png" /></p>
<p>As said above, there might be some times when the service we depend on and call (BPM in our case) is temporarily not available. Either because it is temporarily down or overloaded. If this happens, the Spring Container component will send the <strong>ContainerAnomaly</strong> event into the <strong>container-anomaly-retry</strong> topic.</p>
<p>The Spring Container component will also subscribe to that topic and will retry the call to BPM for each <strong>ContainerAnomalyRetry</strong> event it reads from the <strong>container-anomaly-retry</strong> topic. However, it will only make the call to BPM after certain delay, so that we don't collapse the service with retries, which will increase based on the retry attempt number:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">ContainerEvent</span><span class="o">.</span><span class="na">CONTAINER_ANOMALY_RETRY</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// --------------------------------------------</span>
        <span class="c1">// ContainerAnomalyEventRetry events</span>
        <span class="c1">//---------------------------------------------</span>
        <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Received new ContainerAnomalyEventRetry event: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
        <span class="c1">// Get the ContainerAnomalyRetryEvent objet from the event received</span>
        <span class="n">ContainerAnomalyEventRetry</span> <span class="n">caer</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">value</span><span class="o">(),</span> <span class="n">ContainerAnomalyEventRetry</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">time_to_wait</span> <span class="o">=</span> <span class="n">caer</span><span class="o">.</span><span class="na">getRetries</span><span class="o">()</span> <span class="o">*</span> <span class="mi">10</span><span class="o">;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;This is a BPM call retry. Applying a delay of &quot;</span> <span class="o">+</span> <span class="n">time_to_wait</span> <span class="o">+</span> <span class="s">&quot; seconds&quot;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">time_to_wait</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">bpmAgent</span><span class="o">.</span><span class="na">callBPM</span><span class="o">(</span><span class="n">caer</span><span class="o">,</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>The ContainerAnomalyEventRetry events sent to the container-anomaly-retry topic look like this:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;containerID&quot;</span><span class="p">:</span> <span class="s2">&quot;1111&quot;</span><span class="p">,</span>
  <span class="nt">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;ambiant_temperature&quot;</span><span class="p">:</span> <span class="mf">19.8447</span><span class="p">,</span>
    <span class="nt">&quot;carbon_dioxide_level&quot;</span><span class="p">:</span> <span class="mf">4.42579</span><span class="p">,</span>
    <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;defrost_cycle&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;humidity_level&quot;</span><span class="p">:</span> <span class="mf">60.3148</span><span class="p">,</span>
    <span class="nt">&quot;kilowatts&quot;</span><span class="p">:</span> <span class="mf">3.44686</span><span class="p">,</span>
    <span class="nt">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">31.4</span><span class="p">,</span>
    <span class="nt">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">121.5</span><span class="p">,</span>
    <span class="nt">&quot;nitrogen_level&quot;</span><span class="p">:</span> <span class="mf">79.4046</span><span class="p">,</span>
    <span class="nt">&quot;oxygen_level&quot;</span><span class="p">:</span> <span class="mf">20.4543</span><span class="p">,</span>
    <span class="nt">&quot;target_temperature&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">5.49647</span><span class="p">,</span>
    <span class="nt">&quot;time_door_open&quot;</span><span class="p">:</span> <span class="mf">0.822024</span><span class="p">,</span>
    <span class="nt">&quot;vent_1&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;vent_2&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;vent_3&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="nt">&quot;retries&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1583752031</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ContainerAnomalyRetry&quot;</span>
<span class="p">}</span>
</pre></div>

<p>where you can see a new attribute called <strong>retries</strong> so that we keep the count of how many times we have called the BPM service. If the BPM service is still unreachable/unavailable after three attempts, the Spring Container component will eventually send a <strong>ContainerAnomalyDead</strong> event into the <strong>container-anomaly-dead</strong> topic, which should be somehow monitored to take the appropriate action based on the type of events that get published:</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">toRetryTopic</span><span class="o">(</span><span class="n">ContainerAnomalyEvent</span> <span class="n">cae</span><span class="o">){</span>
    <span class="n">ContainerAnomalyEventRetry</span> <span class="n">caer</span><span class="o">;</span>

    <span class="c1">// Add one retry to ContainerAnomalyEventRetry or create a new one</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cae</span> <span class="k">instanceof</span> <span class="n">ContainerAnomalyEventRetry</span><span class="o">){</span>
        <span class="n">caer</span> <span class="o">=</span> <span class="o">(</span><span class="n">ContainerAnomalyEventRetry</span><span class="o">)</span><span class="n">cae</span><span class="o">;</span>
        <span class="n">caer</span><span class="o">.</span><span class="na">setRetries</span><span class="o">(</span><span class="n">caer</span><span class="o">.</span><span class="na">getRetries</span><span class="o">()+</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="n">caer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerAnomalyEventRetry</span><span class="o">(</span><span class="n">cae</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">caer</span><span class="o">.</span><span class="na">getRetries</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">){</span>
        <span class="c1">// send the event to the container anomaly dead queue</span>
        <span class="n">toDeadTopic</span><span class="o">(</span><span class="n">cae</span><span class="o">,</span><span class="s">&quot;No more BPM process retries left&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Send the event to the container anomaly retry queue</span>
        <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Sending ContainerAnomalyEventRetry event for containerID: &quot;</span> <span class="o">+</span> <span class="n">cae</span><span class="o">.</span><span class="na">getContainerID</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; to the container anomaly retry topic&quot;</span><span class="o">);</span>
        <span class="n">containerAnomalyRetryProducer</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="n">caer</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>and the ContainerAnomalyDead event looks like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;containerID&quot;</span><span class="p">:</span> <span class="s2">&quot;1111&quot;</span><span class="p">,</span>
  <span class="nt">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;ambiant_temperature&quot;</span><span class="p">:</span> <span class="mf">19.8447</span><span class="p">,</span>
    <span class="nt">&quot;carbon_dioxide_level&quot;</span><span class="p">:</span> <span class="mf">4.42579</span><span class="p">,</span>
    <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;defrost_cycle&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;humidity_level&quot;</span><span class="p">:</span> <span class="mf">60.3148</span><span class="p">,</span>
    <span class="nt">&quot;kilowatts&quot;</span><span class="p">:</span> <span class="mf">3.44686</span><span class="p">,</span>
    <span class="nt">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">31.4</span><span class="p">,</span>
    <span class="nt">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">121.5</span><span class="p">,</span>
    <span class="nt">&quot;nitrogen_level&quot;</span><span class="p">:</span> <span class="mf">79.4046</span><span class="p">,</span>
    <span class="nt">&quot;oxygen_level&quot;</span><span class="p">:</span> <span class="mf">20.4543</span><span class="p">,</span>
    <span class="nt">&quot;target_temperature&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">5.49647</span><span class="p">,</span>
    <span class="nt">&quot;time_door_open&quot;</span><span class="p">:</span> <span class="mf">0.822024</span><span class="p">,</span>
    <span class="nt">&quot;vent_1&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;vent_2&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;vent_3&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;No more BPM process retries left&quot;</span><span class="p">,</span>
  <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1583752031</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ContainerAnomalyDead&quot;</span>
<span class="p">}</span>
</pre></div>

<p>where you can see we have added the <strong>reason</strong> so that if any operator or automated system monitors this queue, they know what might be the problem.</p>
<h3 id="errors">Errors</h3>
<p><img alt="error" src="../images/Slide2.png" /></p>
<p>As said earlier, when implementing request retry and graceful failure mechanisms for a, potentially external, service, we want to retry only when the service is unreachable/unavailable and not when there is an error in the data we are calling the service with, an error with the service url or something on those lines so that we don't keep retrying calls we know they are bound to fail beforehand.</p>
<p>As a result, when this happens, we simply send the the event to the dead letter queue with a meaningful error message/code so that monitoring systems (either automated ones or operators monitoring these queues) can act accordingly.</p>
<p>In our case, we are considering an error any failed attempt to get authenticated against BPM, either due to bad credentials or login url, and consider that retrying those requests will only put more load onto the system. As a result, we simply send a <strong>ContainerAnomalyDead</strong> event into the <strong>container-anomaly-dead</strong> topic instead of retrying.</p>
<div class="codehilite"><pre><span></span><span class="c1">// Manage BPM token</span>
<span class="k">if</span> <span class="o">(</span><span class="n">bpm_token</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="o">||</span> <span class="n">expired</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Logging</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bpm_token</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="o">)</span> <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;No BPM token - Calling the BPM authentication service&quot;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">expired</span><span class="o">)</span> <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;BPM token expired - Calling the BPM authentication service&quot;</span><span class="o">);</span>
    <span class="c1">// Get the BPM token</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">bpm_token</span> <span class="o">=</span> <span class="n">getBPMToken</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/*</span>
<span class="cm">        * DEAD</span>
<span class="cm">        * We Consider not being able to authenticate with BPM a severe problem as it does not</span>
<span class="cm">        * make sense to retry calling a service which we can&#39;t authenticate against.</span>
<span class="cm">        */</span>
        <span class="n">toDeadTopic</span><span class="o">(</span><span class="n">ContainerAnomalyEvent</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>In this case, the ContainerAnomalyDead event looks exactly the same as in the service unavailable section but with a different reason, potentially indicating another problem this time.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;containerID&quot;</span><span class="p">:</span> <span class="s2">&quot;1111&quot;</span><span class="p">,</span>
  <span class="nt">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;ambiant_temperature&quot;</span><span class="p">:</span> <span class="mf">19.8447</span><span class="p">,</span>
    <span class="nt">&quot;carbon_dioxide_level&quot;</span><span class="p">:</span> <span class="mf">4.42579</span><span class="p">,</span>
    <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;defrost_cycle&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;humidity_level&quot;</span><span class="p">:</span> <span class="mf">60.3148</span><span class="p">,</span>
    <span class="nt">&quot;kilowatts&quot;</span><span class="p">:</span> <span class="mf">3.44686</span><span class="p">,</span>
    <span class="nt">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">31.4</span><span class="p">,</span>
    <span class="nt">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">121.5</span><span class="p">,</span>
    <span class="nt">&quot;nitrogen_level&quot;</span><span class="p">:</span> <span class="mf">79.4046</span><span class="p">,</span>
    <span class="nt">&quot;oxygen_level&quot;</span><span class="p">:</span> <span class="mf">20.4543</span><span class="p">,</span>
    <span class="nt">&quot;target_temperature&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">5.49647</span><span class="p">,</span>
    <span class="nt">&quot;time_door_open&quot;</span><span class="p">:</span> <span class="mf">0.822024</span><span class="p">,</span>
    <span class="nt">&quot;vent_1&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;vent_2&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;vent_3&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;BPM authentication exception&quot;</span><span class="p">,</span>
  <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1583751647</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ContainerAnomalyDead&quot;</span>
<span class="p">}</span>
</pre></div>

<h3 id="what-to-do-next">What to do next</h3>
<p>As already said, the idea of implementing the Request Retry and Dead Letter Queue Pattern is not only to alleviate the load an, external or not, system we depend on might have but also as a sink for potential problems. Whether ContainerAnomaly messages end up in the container-anomaly-dead topic because the BPM service was (temporarily or not) unavailable or there was an, expected or not, error in the system, this dead letter queue will ideally have some automated/manual monitoring system/person so that the appropriate action can be taken as a result in an attempt to minimize the incorrect functioning of your system/service. This is, for instance, one good reason to wrap up your messages being sent to the dead letter queue with some code/reason that can be quickly understood by whatever monitor system. Not only understood but possibly aggregated and queried to better understand your system performance over time.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../saga/saga/" title="Saga applied to container solution" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Saga applied to container solution
              </span>
            </div>
          </a>
        
        
          <a href="../../rejection/rejection/" title="Order rejection principle" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Order rejection principle
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>