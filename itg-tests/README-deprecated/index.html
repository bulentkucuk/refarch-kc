



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Reefer container shipment solution integration tests - Container Shipment EDA reference implementation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#reefer-container-shipment-solution-integration-tests" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Container Shipment EDA reference implementation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Container Shipment EDA reference implementation
            </span>
            <span class="md-header-nav__topic">
              Reefer container shipment solution integration tests
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Container Shipment EDA reference implementation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Container Shipment EDA reference implementation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Business problem statement
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Business problem statement
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../analysis/readme/" title="Event storming analysis" class="md-nav__link">
      Event storming analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/readme/" title="From Analysis to Microservice Specifications" class="md-nav__link">
      From Analysis to Microservice Specifications
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Development practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-order-ms" title="Order microservice with CQRS and Event Sourcing" class="md-nav__link">
      Order microservice with CQRS and Event Sourcing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/kstreams/" title="Container microservice with event sourcing and Kafka streams" class="md-nav__link">
      Container microservice with event sourcing and Kafka streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/flask" title="Container microservice with Python" class="md-nav__link">
      Container microservice with Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/springboot" title="Container microservice with Springboot - Spring Kafka and PostgreSQL" class="md-nav__link">
      Container microservice with Springboot - Spring Kafka and PostgreSQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../avro/avro/" title="Adopting Schema Registry and Avro" class="md-nav__link">
      Adopting Schema Registry and Avro
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../deployments/reposlist/" title="Related repositories" class="md-nav__link">
      Related repositories
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/backing-services/" title="Backing Services" class="md-nav__link">
      Backing Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployments/application-components/" title="Application Components" class="md-nav__link">
      Application Components
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../security/" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Integration tests
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Integration tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../itgtests/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../happy-path/happy_path/" title="Happy Path" class="md-nav__link">
      Happy Path
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saga/saga/" title="Saga Pattern" class="md-nav__link">
      Saga Pattern
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../containerAnomaly/containerAnomaly/" title="Container Anomaly" class="md-nav__link">
      Container Anomaly
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../demo/readme/" title="Demonstration script" class="md-nav__link">
      Demonstration script
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" title="pre-requisites" class="md-nav__link">
    pre-requisites
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-the-python-environment-as-docker-image" title="Building the python environment as docker image" class="md-nav__link">
    Building the python environment as docker image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-all-services-are-running" title="Ensure all services are running" class="md-nav__link">
    Ensure all services are running
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-the-python-environment" title="Run the python environment" class="md-nav__link">
    Run the python environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-proof-the-event-sourcing" title="How to proof the event sourcing" class="md-nav__link">
    How to proof the event sourcing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replay-all-events-for-a-given-key" title="Replay all events for a given key" class="md-nav__link">
    Replay all events for a given key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#happy-path-for-the-order-life-cycle-validating-cqrs" title="Happy path for the order life cycle: Validating CQRS" class="md-nav__link">
    Happy path for the order life cycle: Validating CQRS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#failure-on-query-service" title="Failure on query service" class="md-nav__link">
    Failure on query service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-proof-the-saga-pattern" title="How to proof the SAGA pattern" class="md-nav__link">
    How to proof the SAGA pattern
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc/edit/master/docs/itg-tests/README-deprecated.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="reefer-container-shipment-solution-integration-tests">Reefer container shipment solution integration tests</h1>
<p>The <code>itg-tests</code> folder includes a set of tests to validate most of the event-driven microservice patterns like, event sourcing with fail over, CQRS and Saga patterns with recovery and fail over. (See our summary on those patterns <a href="https://ibm-cloud-architecture.github.io/refarch-eda/design-patterns/ED-patterns/">here</a>)</p>
<p>These integration tests are done in Python to illustrate how to use Kafka python module of <a href="https://github.com/confluentinc/confluent-kafka-python">this github</a> and because Python is nice to use for writing integration tests.</p>
<h2 id="pre-requisites">pre-requisites</h2>
<h3 id="building-the-python-environment-as-docker-image">Building the python environment as docker image</h3>
<p>To avoid impacting your environment we use a dockerfile to get the basic of python 3.7.x and other needed modules like kafka, http requests, pytest... So build your python image with all the needed libraries, use the following commands:</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> docker
docker build -t ibmcase/python .
</pre></div>

<h3 id="ensure-all-services-are-running">Ensure all services are running</h3>
<div class="admonition note">
<p class="admonition-title">Note<p>This documentation assumes the solution is running within MINIKUBE or docker compose, but tests will work the same with docker-compose, just replace MINIKUBE with LOCAL as argument of the scripts. Integration tests run also with Event Streams on Cloud and the microservices deployed on kubernetes or openshift.</p>
</p>
</div>
<p>Be sure to be logged into the kubernetes cluster. We are using the <code>greencompute</code> namespace. </p>
<div class="codehilite"><pre><span></span>kubectl get pods -n greencompute
</pre></div>

<div class="codehilite"><pre><span></span>NAME                                         READY   STATUS    RESTARTS   AGE
fleetms-deployment-f85cb679d-582pp           1/1     Running   2          14d
kafkabitmani-0                               1/1     Running   1          3d23h
kafkabitmani-zookeeper-0                     1/1     Running   0          3d23h
kcsolution-kc-ui-76b7b4fccf-z85j5            1/1     Running   1          8d
ordercommandms-deployment-857865854f-7mzqs   1/1     Running   0          3d21h
orderqueryms-deployment-778d79d99c-lrgfs     1/1     Running   0          3d21h
postgre-db-postgresql-0                      1/1     Running   2          14d
</pre></div>

<h2 id="run-the-python-environment">Run the python environment</h2>
<p>With the image <code>ibmcase/python</code>, you will be able to run the different integration tests. For example, the following commands will start a bash shell with the python environment, mounting the local filesystem into the docker /home folder, and connect to the same network as the Kafka broker and the other solution components are running into:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">pwd</span>
itg-tests
$ ./startPythonEnv.sh MINIKUBE              <span class="o">(</span>or use LOCAL<span class="o">)</span>
root@fe61560d0cc4:/# 
</pre></div>

<p>From this shell, first specify where python should find the new modules, by setting the environment variable <code>PYTHONPATH</code>:</p>
<p><div class="codehilite"><pre><span></span>root@fe61560d0cc4:/# export PYTHONPATH=/home
root@fe61560d0cc4:/# cd /home
</pre></div>
As the startPythonEnv is mounting the local <code>itg-tests</code> folder to the <code>/home</code> folder inside the docker container, we can access all the integration tests, and execute them ...</p>
<h2 id="how-to-proof-the-event-sourcing">How to proof the event sourcing</h2>
<p>The goal of this test is to illustrate the happy path for event sourcing: all events for an order, are persisted in kafka, in the order of arrival, and a consumer with no offset commit, could run and help to answer to the question: <strong>What happened to the orderId 75?</strong></p>
<p>We want to validate the order events are sequential over time, and it is possible to replay the loading of events from time origin.</p>
<p><img alt="" src="../es-test.png" /></p>
<h3 id="replay-all-events-for-a-given-key">Replay all events for a given key</h3>
<ol>
<li>
<p>First start the python docker container, so we can execute any python code. The script connects to the docker network where kafka runs. </p>
<div class="codehilite"><pre><span></span>cd itg_tests
./startPythonEnv.sh MINIKUBE
</pre></div>

<p>In the bash session, use the following command to ensure python knows how to get our new defined modules like the kafka consumer and producer:
<div class="codehilite"><pre><span></span>export PYTHONPATH=/home
cd /home/es-it
</pre></div></p>
</li>
<li>
<p>Start python interpreter with the producer events code with orderID set to 75.</p>
<div class="codehilite"><pre><span></span>$ python ProducerOrderEvents.py <span class="m">75</span>
The arguments are:  <span class="o">[</span><span class="s1">&#39;ProducerOrderEvents.py&#39;</span>, <span class="s1">&#39;75&#39;</span><span class="o">]</span>
Generate events <span class="k">for</span> <span class="m">75</span>
Create order <span class="k">for</span> <span class="m">75</span>
    <span class="m">1</span>- CreateOrder:<span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;timestamp&quot;</span>: <span class="m">1555149614</span>, <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;OrderCreated&quot;</span>, <span class="s2">&quot;payload&quot;</span>: <span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;productID&quot;</span>: <span class="s2">&quot;FreshFoodItg&quot;</span>, <span class="s2">&quot;customerID&quot;</span>: <span class="s2">&quot;Customer007&quot;</span>, <span class="s2">&quot;quantity&quot;</span>: <span class="m">180</span>, <span class="s2">&quot;pickupAddress&quot;</span>: <span class="o">{</span><span class="s2">&quot;street&quot;</span>: <span class="s2">&quot;astreet&quot;</span>, <span class="s2">&quot;city&quot;</span>: <span class="s2">&quot;Oakland&quot;</span>, <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;USA&quot;</span>, <span class="s2">&quot;state&quot;</span>: <span class="s2">&quot;CA&quot;</span>, <span class="s2">&quot;zipcode&quot;</span>: <span class="s2">&quot;95000&quot;</span><span class="o">}</span>, <span class="s2">&quot;destinationAddress&quot;</span>: <span class="o">{</span><span class="s2">&quot;street&quot;</span>: <span class="s2">&quot;bstreet&quot;</span>, <span class="s2">&quot;city&quot;</span>: <span class="s2">&quot;Beijing&quot;</span>, <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;China&quot;</span>, <span class="s2">&quot;state&quot;</span>: <span class="s2">&quot;NE&quot;</span>, <span class="s2">&quot;zipcode&quot;</span>: <span class="s2">&quot;09000&quot;</span><span class="o">}</span>, <span class="s2">&quot;pickupDate&quot;</span>: <span class="s2">&quot;2019-05-25&quot;</span>, <span class="s2">&quot;expectedDeliveryDate&quot;</span>: <span class="s2">&quot;2019-06-25&quot;</span><span class="o">}}</span>
<span class="o">{</span><span class="s1">&#39;bootstrap.servers&#39;</span>: <span class="s1">&#39;kafka1:9092&#39;</span>, <span class="s1">&#39;group.id&#39;</span>: <span class="s1">&#39;OrderProducerPython&#39;</span><span class="o">}</span>
Message delivered to orders <span class="o">[</span><span class="m">0</span><span class="o">]</span>
    <span class="m">2</span>- Producer accept the offer so now the order is booked:<span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;timestamp&quot;</span>: <span class="m">1555317000</span>, <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;OrderBooked&quot;</span>, <span class="s2">&quot;payload&quot;</span>: <span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;productID&quot;</span>: <span class="s2">&quot;FreshFoodItg&quot;</span>, <span class="s2">&quot;customerID&quot;</span>: <span class="s2">&quot;Customer007&quot;</span>, <span class="s2">&quot;quantity&quot;</span>: <span class="m">180</span>, <span class="s2">&quot;pickupAddress&quot;</span>: <span class="o">{</span><span class="s2">&quot;street&quot;</span>: <span class="s2">&quot;astreet&quot;</span>, <span class="s2">&quot;city&quot;</span>: <span class="s2">&quot;Oakland&quot;</span>, <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;USA&quot;</span>, <span class="s2">&quot;state&quot;</span>: <span class="s2">&quot;CA&quot;</span>, <span class="s2">&quot;zipcode&quot;</span>: <span class="s2">&quot;95000&quot;</span><span class="o">}</span>, <span class="s2">&quot;destinationAddress&quot;</span>: <span class="o">{</span><span class="s2">&quot;street&quot;</span>: <span class="s2">&quot;bstreet&quot;</span>, <span class="s2">&quot;city&quot;</span>: <span class="s2">&quot;Beijing&quot;</span>, <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;China&quot;</span>, <span class="s2">&quot;state&quot;</span>: <span class="s2">&quot;NE&quot;</span>, <span class="s2">&quot;zipcode&quot;</span>: <span class="s2">&quot;09000&quot;</span><span class="o">}</span>, <span class="s2">&quot;pickupDate&quot;</span>: <span class="s2">&quot;2019-05-25&quot;</span>, <span class="s2">&quot;expectedDeliveryDate&quot;</span>: <span class="s2">&quot;2019-06-25&quot;</span><span class="o">}}</span>
Message delivered to orders <span class="o">[</span><span class="m">0</span><span class="o">]</span>
    <span class="m">3</span>- Voyage is assigned to order:<span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;timestamp&quot;</span>: <span class="m">1555317300</span>, <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;OrderAssigned&quot;</span>, <span class="s2">&quot;payload&quot;</span>: <span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;voyageID&quot;</span>: <span class="s2">&quot;voyage21&quot;</span><span class="o">}}</span>
Message delivered to orders <span class="o">[</span><span class="m">0</span><span class="o">]</span>
    <span class="m">4</span>- Allocate Reefer to order:<span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;timestamp&quot;</span>: <span class="m">1555405800</span>, <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;ContainerAllocated&quot;</span>, <span class="s2">&quot;payload&quot;</span>: <span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;containerID&quot;</span>: <span class="s2">&quot;c13&quot;</span><span class="o">}}</span>
Message delivered to orders <span class="o">[</span><span class="m">0</span><span class="o">]</span>
    <span class="m">5</span>- Reefer loaded with goods ready <span class="k">for</span> Voyage:<span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;timestamp&quot;</span>: <span class="m">1557930600</span>, <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;FullContainerVoyageReady&quot;</span>, <span class="s2">&quot;payload&quot;</span>: <span class="o">{</span><span class="s2">&quot;orderID&quot;</span>: <span class="s2">&quot;75&quot;</span>, <span class="s2">&quot;containerID&quot;</span>: <span class="s2">&quot;c13&quot;</span><span class="o">}}</span>
Message delivered to orders <span class="o">[</span><span class="m">0</span><span class="o">]</span>
</pre></div>

</li>
<li>
<p>Now we can start the consumer to see the event coming with different time stamps. In a separate <code>terminal</code> windows run the command:</p>
<div class="codehilite"><pre><span></span>./runOrderConsumer.sh MINIKUBE 75
</pre></div>

<p>You should get the following results</p>
<div class="codehilite"><pre><span></span>@@@ pollNextOrder orders partition: [0] at offset 8 with key b&#39;75&#39;:
    value: {&quot;orderID&quot;: &quot;75&quot;, &quot;timestamp&quot;: 1555149614, &quot;type&quot;: &quot;OrderCreated&quot;, &quot;payload&quot;: {&quot;orderID&quot;: &quot;75&quot;, &quot;productID&quot;: &quot;FreshFoodItg&quot;, &quot;customerID&quot;: &quot;Customer007&quot;, &quot;quantity&quot;: 180, &quot;pickupAddress&quot;: {&quot;street&quot;: &quot;astreet&quot;, &quot;city&quot;: &quot;Oakland&quot;, &quot;country&quot;: &quot;USA&quot;, &quot;state&quot;: &quot;CA&quot;, &quot;zipcode&quot;: &quot;95000&quot;}, &quot;destinationAddress&quot;: {&quot;street&quot;: &quot;bstreet&quot;, &quot;city&quot;: &quot;Beijing&quot;, &quot;country&quot;: &quot;China&quot;, &quot;state&quot;: &quot;NE&quot;, &quot;zipcode&quot;: &quot;09000&quot;}, &quot;pickupDate&quot;: &quot;2019-05-25&quot;, &quot;expectedDeliveryDate&quot;: &quot;2019-06-25&quot;}}
@@@ pollNextOrder orders partition: [0] at offset 9 with key b&#39;75&#39;:
    value: {&quot;orderID&quot;: &quot;75&quot;, &quot;timestamp&quot;: 1555317000, &quot;type&quot;: &quot;OrderBooked&quot;, &quot;payload&quot;: {&quot;orderID&quot;: &quot;75&quot;, &quot;productID&quot;: &quot;FreshFoodItg&quot;, &quot;customerID&quot;: &quot;Customer007&quot;, &quot;quantity&quot;: 180, &quot;pickupAddress&quot;: {&quot;street&quot;: &quot;astreet&quot;, &quot;city&quot;: &quot;Oakland&quot;, &quot;country&quot;: &quot;USA&quot;, &quot;state&quot;: &quot;CA&quot;, &quot;zipcode&quot;: &quot;95000&quot;}, &quot;destinationAddress&quot;: {&quot;street&quot;: &quot;bstreet&quot;, &quot;city&quot;: &quot;Beijing&quot;, &quot;country&quot;: &quot;China&quot;, &quot;state&quot;: &quot;NE&quot;, &quot;zipcode&quot;: &quot;09000&quot;}, &quot;pickupDate&quot;: &quot;2019-05-25&quot;, &quot;expectedDeliveryDate&quot;: &quot;2019-06-25&quot;}}
@@@ pollNextOrder orders partition: [0] at offset 10 with key b&#39;75&#39;:
    value: {&quot;orderID&quot;: &quot;75&quot;, &quot;timestamp&quot;: 1555317300, &quot;type&quot;: &quot;OrderAssigned&quot;, &quot;payload&quot;: {&quot;orderID&quot;: &quot;75&quot;, &quot;voyageID&quot;: &quot;voyage21&quot;}}
@@@ pollNextOrder orders partition: [0] at offset 11 with key b&#39;75&#39;:
    value: {&quot;orderID&quot;: &quot;75&quot;, &quot;timestamp&quot;: 1555405800, &quot;type&quot;: &quot;ContainerAllocated&quot;, &quot;payload&quot;: {&quot;orderID&quot;: &quot;75&quot;, &quot;containerID&quot;: &quot;c13&quot;}}
@@@ pollNextOrder orders partition: [0] at offset 12 with key b&#39;75&#39;:
    value: {&quot;orderID&quot;: &quot;75&quot;, &quot;timestamp&quot;: 1557930600, &quot;type&quot;: &quot;FullContainerVoyageReady&quot;, &quot;payload&quot;: {&quot;orderID&quot;: &quot;75&quot;, &quot;containerID&quot;: &quot;c13&quot;}}
</pre></div>

</li>
<li>
<p>Stopping with Ctrl-C (it can take time for python to get the keyboard interrupt) and then restarting the same consumer will bring you the same content. We can always answer the question at different time, but still get the same answer. </p>
</li>
</ol>
<p>The tests are under the <code>itg-tests/es-it</code> folder. The testin <code>es-it/ProducerOrderEvents.py</code> create the order events, and when combined with an order consumer give you the tracing of the process. The diagram below illustrates this simple environment. </p>
<ul>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc/blob/master/itg-tests/es-it/EventSourcingTests.py">EventSourcingTests.py</a> uses the event backbone, and the order microservices. </li>
</ul>
<p>To run the tests set the KAFKA_BROKERS and KAFKA_APIKEY environment variables</p>
<h3 id="happy-path-for-the-order-life-cycle-validating-cqrs">Happy path for the order life cycle: Validating CQRS</h3>
<p>A classical happy path for a event-driven microservice is to receive a command to do something (could be an API operation (POST a new order)), validate the command, create a new event (OrderCreated) and append it to event log, then update its internal state, and may be run side effect like returning a response to the command initiator, or trigger a call to an external service to initiate a business process or a business task.  </p>
<p>We assume the python image was built, so you can use the following command to run the first test that creates an order via HTTP POST on the Order Command microservice (the write model), uses Kafka consumer to get the different events and then use HTTP GET to query the Order query microservices (the read model). The <code>OrdersPython/ValidateOrderCreation.py</code> code is documented and should be self-explanatory. The order state diagram is <a href="https://ibm-cloud-architecture.github.io/refarch-kc/design/readme/#shipment-order-lifecycle-and-state-change-events">presented here.</a></p>
<div class="codehilite"><pre><span></span>$ <span class="nb">pwd</span>
itg-tests

$  ./startPythonEnv.sh LOCAL   <span class="o">(</span>or MINIKUBE<span class="o">)</span>

root@fe61560d0cc4:/# <span class="nb">cd</span> home/OrdersPython
root@fe61560d0cc4:/# python  ValidateOrderCreation.py
</pre></div>

<p>The implementation uses a set of constructs to poll the <code>orders</code> topic for events and  timing out if not events are there.</p>
<h3 id="failure-on-query-service">Failure on query service</h3>
<p>One possible bad path, is when the order query microservice fails, and needs to recover from failure. In this case it should reload the events from last commited offset and update its internal states without running any code that could lead to side effect. </p>
<p>To test this path, we first manual kill the docker container running the order query microservice, then use the same code as above to create an order. The last step of the call fails as the order created event was not processed by the query microservice, the data was not uploaded to its own projection. 
Restarting the microservice, and going to the URL http://localhost:11080/orders/byManuf/FishFarm, you will see the order is now part of the data of this service.</p>
<h2 id="how-to-proof-the-saga-pattern">How to proof the SAGA pattern</h2>
<p>We want to validate the SAGA pattern to support the long-running, cross microservices, order transactions. The diagram is illustrating the use case we want to proof and tests:</p>
<p><img alt="" src="../saga-ctx.png" /></p>
<p>What we need to proof for the happy path:</p>
<ul>
<li>Send a new order to the order microservice via API with all the data to ship fresh goods from two countries separated by ocean</li>
<li>verify the status of the order is pending</li>
<li>The unique cross services key is the order ID</li>
<li>verify orderCreated event was published</li>
<li>verify voyage was allocated to order</li>
<li>verify container was allocated to order</li>
<li>verify ship has new containers added to its plan shipping plan </li>
<li>verify the status of the order is assigned</li>
</ul>
<p>Business exeception error: no container for this type of load is available in this time frame. So the business response will be to keep the order in pending but trigger a business process for a customer representative to be in contact with the manufacturer for a remediation plan. </p>
<ul>
<li>Verify the response to the container service is an OrderUnfulled event.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>