



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Application Components - Container Shipment EDA reference implementation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#environment-prerequisites" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Container Shipment EDA reference implementation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Container Shipment EDA reference implementation
            </span>
            <span class="md-header-nav__topic">
              Application Components
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Container Shipment EDA reference implementation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Container Shipment EDA reference implementation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Business problem statement
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Business problem statement
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../analysis/readme/" title="Event storming analysis" class="md-nav__link">
      Event storming analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/readme/" title="From Analysis to Microservice Specifications" class="md-nav__link">
      From Analysis to Microservice Specifications
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Development practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-order-ms" title="Order microservice with CQRS and Event Sourcing" class="md-nav__link">
      Order microservice with CQRS and Event Sourcing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/kstreams/" title="Container microservice with event sourcing and Kafka streams" class="md-nav__link">
      Container microservice with event sourcing and Kafka streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/flask" title="Container microservice with Python" class="md-nav__link">
      Container microservice with Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/springboot" title="Container microservice with Springboot - Spring Kafka and PostgreSQL" class="md-nav__link">
      Container microservice with Springboot - Spring Kafka and PostgreSQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../avro/avro/" title="Adopting Schema Registry and Avro" class="md-nav__link">
      Adopting Schema Registry and Avro
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../reposlist/" title="Related repositories" class="md-nav__link">
      Related repositories
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../backing-services/" title="Backing Services" class="md-nav__link">
      Backing Services
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Application Components
      </label>
    
    <a href="./" title="Application Components" class="md-nav__link md-nav__link--active">
      Application Components
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#environment-prerequisites" title="Environment prerequisites" class="md-nav__link">
    Environment prerequisites
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kafka-topic-creation" title="Kafka Topic Creation" class="md-nav__link">
    Kafka Topic Creation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-registries" title="Docker registries" class="md-nav__link">
    Docker registries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibm-cloud-container-registry" title="IBM Cloud Container Registry" class="md-nav__link">
    IBM Cloud Container Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-a-private-image-repository" title="Define a private image repository" class="md-nav__link">
    Define a private image repository
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-registry-token" title="Private Registry Token" class="md-nav__link">
    Private Registry Token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-kubernetes" title="Basic Kubernetes" class="md-nav__link">
    Basic Kubernetes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibm-cloud-kubernetes-service" title="IBM Cloud Kubernetes Service" class="md-nav__link">
    IBM Cloud Kubernetes Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openshift-container-platform-311" title="OpenShift Container Platform 3.11" class="md-nav__link">
    OpenShift Container Platform 3.11
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openshift-container-platform-4x" title="OpenShift Container Platform 4.X" class="md-nav__link">
    OpenShift Container Platform 4.X
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-application-microservices" title="Deploy application microservices" class="md-nav__link">
    Deploy application microservices
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-master-repository" title="Using the master repository" class="md-nav__link">
    Using the master repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-order-command-microservice" title="Deploy Order Command microservice" class="md-nav__link">
    Deploy Order Command microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-order-query-microservice" title="Deploy Order Query microservice" class="md-nav__link">
    Deploy Order Query microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-container-microservice" title="Deploy Container microservice" class="md-nav__link">
    Deploy Container microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-voyages-microservice" title="Deploy Voyages microservice" class="md-nav__link">
    Deploy Voyages microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-fleet-simulator-microservice" title="Deploy the Fleet Simulator microservice" class="md-nav__link">
    Deploy the Fleet Simulator microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-user-interface-microservice" title="Deploy User Interface microservice" class="md-nav__link">
    Deploy User Interface microservice
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-tests" title="Integration Tests" class="md-nav__link">
    Integration Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#universal-deployment-considerations" title="Universal deployment considerations" class="md-nav__link">
    Universal deployment considerations
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../security/" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Integration tests
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Integration tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/itgtests/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/happy-path/happy_path/" title="Happy Path" class="md-nav__link">
      Happy Path
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/saga/saga/" title="Saga Pattern" class="md-nav__link">
      Saga Pattern
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../itg-tests/containerAnomaly/containerAnomaly/" title="Container Anomaly" class="md-nav__link">
      Container Anomaly
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../demo/readme/" title="Demonstration script" class="md-nav__link">
      Demonstration script
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#environment-prerequisites" title="Environment prerequisites" class="md-nav__link">
    Environment prerequisites
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kafka-topic-creation" title="Kafka Topic Creation" class="md-nav__link">
    Kafka Topic Creation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-registries" title="Docker registries" class="md-nav__link">
    Docker registries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibm-cloud-container-registry" title="IBM Cloud Container Registry" class="md-nav__link">
    IBM Cloud Container Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-a-private-image-repository" title="Define a private image repository" class="md-nav__link">
    Define a private image repository
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-registry-token" title="Private Registry Token" class="md-nav__link">
    Private Registry Token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-kubernetes" title="Basic Kubernetes" class="md-nav__link">
    Basic Kubernetes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibm-cloud-kubernetes-service" title="IBM Cloud Kubernetes Service" class="md-nav__link">
    IBM Cloud Kubernetes Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openshift-container-platform-311" title="OpenShift Container Platform 3.11" class="md-nav__link">
    OpenShift Container Platform 3.11
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openshift-container-platform-4x" title="OpenShift Container Platform 4.X" class="md-nav__link">
    OpenShift Container Platform 4.X
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-application-microservices" title="Deploy application microservices" class="md-nav__link">
    Deploy application microservices
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-master-repository" title="Using the master repository" class="md-nav__link">
    Using the master repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-order-command-microservice" title="Deploy Order Command microservice" class="md-nav__link">
    Deploy Order Command microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-order-query-microservice" title="Deploy Order Query microservice" class="md-nav__link">
    Deploy Order Query microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-container-microservice" title="Deploy Container microservice" class="md-nav__link">
    Deploy Container microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-voyages-microservice" title="Deploy Voyages microservice" class="md-nav__link">
    Deploy Voyages microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-fleet-simulator-microservice" title="Deploy the Fleet Simulator microservice" class="md-nav__link">
    Deploy the Fleet Simulator microservice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-user-interface-microservice" title="Deploy User Interface microservice" class="md-nav__link">
    Deploy User Interface microservice
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-tests" title="Integration Tests" class="md-nav__link">
    Integration Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#universal-deployment-considerations" title="Universal deployment considerations" class="md-nav__link">
    Universal deployment considerations
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc/edit/master/docs/deployments/application-components.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Application Components</h1>
                
                <p>Deployment of application microservices for the Event-Driven Architecture Reference Application</p>
<h2 id="environment-prerequisites">Environment prerequisites</h2>
<h3 id="kafka-topic-creation">Kafka Topic Creation</h3>
<p>You can create the topics using the Event Streams console:</p>
<p><img alt="" src="../images/es-icp-topics.png" /></p>
<p>or if you have manually deployed Event Streams or Kafka, you can use commands similar to the snippet below:</p>
<div class="codehilite"><pre><span></span><span class="c1"># get the name of the Kafka pod</span>
$ <span class="nb">export</span> <span class="nv">NAMESPACE</span><span class="o">=</span>&lt;target k8s namespace / ocp project&gt;
$ <span class="nb">export</span> <span class="nv">KPOF</span><span class="o">=</span><span class="k">$(</span>kubectl get pods  -n <span class="si">${</span><span class="nv">NAMESPACE</span><span class="si">}</span> <span class="p">|</span> grep kafka <span class="p">|</span> awk <span class="s1">&#39;{print $1;}&#39;</span><span class="k">)</span>
$ cat <span class="si">${</span><span class="nv">KPOF</span><span class="si">}</span>
rolling-streams-ibm-es-kafka-sts-0
rolling-streams-ibm-es-kafka-sts-1
rolling-streams-ibm-es-kafka-sts-2
<span class="c1"># Then get the name of the zookeeper service:</span>
$ <span class="nb">export</span> <span class="nv">ZOOKSVC</span><span class="o">=</span><span class="k">$(</span>kubectl get svc -n <span class="si">${</span><span class="nv">NAMESPACE</span><span class="si">}</span> <span class="p">|</span> grep zoo <span class="p">|</span> awk <span class="s1">&#39;{print $1;}&#39;</span> <span class="p">|</span> head -1<span class="k">)</span>
rolling-streams-ibm-es-zookeeper-fixed-ip-svc-0
<span class="c1"># Then remote exec a shell on one of this broker to configure the topic - for example the &quot;orders&quot; topic</span>
$ kubectl <span class="nb">exec</span> -n <span class="si">${</span><span class="nv">NAMESPACE</span><span class="si">}</span> -ti <span class="si">${</span><span class="nv">KPOF</span><span class="si">}</span> -- bash -c <span class="s2">&quot;/opt/kafka/bin/kafka-topics.sh --create  --zookeeper </span><span class="si">${</span><span class="nv">ZOOKSVC</span><span class="si">}</span><span class="s2">:2181 --replication-factor 1 --partitions 1 --topic orders&quot;</span>
</pre></div>

<p>The topics that need to be created are:</p>
<ul>
<li><code>bluewaterContainer</code></li>
<li><code>bluewaterShip</code></li>
<li><code>bluewaterProblem</code></li>
<li><code>orders</code></li>
<li><code>orderCommands</code></li>
<li><code>rejected-orders</code></li>
<li><code>allocated-orders</code></li>
<li><code>errors</code></li>
<li><code>containers</code></li>
<li><code>containerMetrics</code></li>
<li><code>reeferTelemetries</code></li>
</ul>
<p>The command <code>scripts/createTopicsOnK8S.sh</code> creates those topics automatically.</p>
<h2 id="docker-registries">Docker registries</h2>
<p>You will need a Docker image registry to push and pull your images to and from.  There are multiple options depending on your use cases and we are only documenting a subset of potential solutions, including but not limited to IBM Cloud Container Registry, Docker Hub, Quay, etc.</p>
<h3 id="ibm-cloud-container-registry">IBM Cloud Container Registry</h3>
<p>Install IBM Cloud Container Registry CLI plug-in if needed:</p>
<div class="codehilite"><pre><span></span>ibmcloud plugin install container-registry -r Bluemix
</pre></div>

<h3 id="define-a-private-image-repository">Define a private image repository</h3>
<p>Use the <a href="https://cloud.ibm.com/containers-kubernetes/catalog/registry">IBM Cloud Container Registry</a> to push your images and then deploy them to any Kubernetes cluster with access to the public internet.  When deploying enterprise applications, it is strongly recommended to use private registry to protect your images from being used and changed by unauthorized users. Private registries must be set up by the cluster administrator to ensure that the credentials to access the private registry are available to the cluster users.</p>
<p>Create a namespace inside your Container Registry for use here:</p>
<div class="codehilite"><pre><span></span>ibmcloud cr namespace-add ibmcaseeda
</pre></div>

<p>We will use this namespace when tagging the docker images for our microservices. Here is an example of tagging:</p>
<div class="codehilite"><pre><span></span>docker tag ibmcase/kcontainer-ui us.icr.io/ibmcaseeda/kcontainer-ui:latest
</pre></div>

<p>To see the images in your private registry you can use the user interface at <a href="https://cloud.ibm.com/containers-kubernetes/registry/main/private">https://cloud.ibm.com/containers-kubernetes/registry/main/private</a> or the command:</p>
<div class="codehilite"><pre><span></span>ibmcloud cr image-list
</pre></div>

<h4 id="private-registry-token">Private Registry Token</h4>
<p>Each Helm Chart specifies the name of the Docker image to load the containers &amp; pods. To enable access from Kubernetes Nodes to your private registry, an image pull secret is required and will be stored in a Kubernetes secret.  If you are using public Docker Hub image repositories, an image pull secret is not required.</p>
<p><em>Using secret is also mandatory when registry and clusters are not in the same region.</em></p>
<ul>
<li>Verify current secrets for a given namespace:</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl describe secrets -n &lt;target namespace&gt;
</pre></div>

<ul>
<li>Get a security token: <em>(these can be <code>permanent</code> or <code>renewable</code>)</em></li>
</ul>
<div class="codehilite"><pre><span></span>ibmcloud cr token-add --description <span class="s2">&quot;private registry secret for &lt;target namespace&gt;&quot;</span> --non-expiring -q
</pre></div>

<ul>
<li>To list the available tokens:</li>
</ul>
<div class="codehilite"><pre><span></span>ibmcloud cr tokens
</pre></div>

<p>The result:</p>
<blockquote>
<p>TOKEN ID     READONLY   EXPIRY   DESCRIPTION
 2b5ff00e-a..  true       0       token for somebody
 3dbf72eb-6..  true       0       private registry secret for browncompute</p>
</blockquote>
<ul>
<li>Get the token for a given token identifier:</li>
</ul>
<div class="codehilite"><pre><span></span>ibmcloud cr token-get cce5a800-...
</pre></div>

<ul>
<li>Define the secret to store the Event stream API key token information:</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl --namespace &lt;target namespace&gt; create secret docker-registry
&lt;target namespace&gt;-registry-secret  --docker-server<span class="o">=</span>&lt;registry_url&gt; --docker-username<span class="o">=</span>token --docker-password<span class="o">=</span>&lt;token_value&gt; --docker-email<span class="o">=</span>&lt;docker_email&gt;
</pre></div>

<ul>
<li>Verify the secret</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl get secrets -n &lt;target namespace&gt;
</pre></div>

<p>You will see something like below.</p>
<blockquote>
<table>
<thead>
<tr>
<th>NAME</th>
<th>TYPE</th>
<th>DATA</th>
<th>AGE</th>
</tr>
</thead>
<tbody>
<tr>
<td>browncompute-registry-secret</td>
<td>kubernetes.io/dockerconfigjson</td>
<td>1</td>
<td>2m</td>
</tr>
<tr>
<td>default-token-ggwl2</td>
<td>kubernetes.io/service-account-token</td>
<td>3</td>
<td>41m</td>
</tr>
<tr>
<td>eventstreams-apikey</td>
<td>Opaque</td>
<td>1</td>
<td>24m</td>
</tr>
</tbody>
</table>
</blockquote>
<h2 id="basic-kubernetes">Basic Kubernetes</h2>
<h3 id="ibm-cloud-kubernetes-service">IBM Cloud Kubernetes Service</h3>
<p>To create the cluster follow <a href="https://console.bluemix.net/docs/containers/cs_tutorials.html#cs_cluster_tutorial">this tutorial</a>.</p>
<h3 id="openshift-container-platform-311">OpenShift Container Platform 3.11</h3>
<p>This needs to be done once per unique deployment of the entire application.</p>
<ol>
<li>If desired, create a non-default Service Account for usage of deploying and running the K Container reference implementation.  This will become more important in future iterations, so it's best to start small:<ul>
<li>Command: <code>oc create serviceaccount -n &lt;target-namespace&gt; kcontainer-runtime</code></li>
<li>Example: <code>oc create serviceaccount -n eda-refarch kcontainer-runtime</code></li>
</ul>
</li>
<li>The target Service Account needs to be allowed to run containers as <code>anyuid</code> for the time being:<ul>
<li>Command: <code>oc adm policy add-scc-to-user anyuid -z &lt;service-account-name&gt; -n &lt;target-namespace&gt;</code></li>
<li>Example: <code>oc adm policy add-scc-to-user anyuid -z kcontainer-runtime -n eda-refarch</code></li>
<li>NOTE: This requires <code>cluster-admin</code> level privileges.</li>
</ul>
</li>
</ol>
<h3 id="openshift-container-platform-4x">OpenShift Container Platform 4.X</h3>
<p><strong>TODO OpenShift Container Platform 4.X Prereqs</strong></p>
<h2 id="deploy-application-microservices">Deploy application microservices</h2>
<h3 id="using-the-master-repository">Using the master repository</h3>
<p>You can download the necessary application microservice repsoitories using scripts provided in the master repository:</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/ibm-cloud-architecture/refarch-kc.git
<span class="nb">cd</span> refarch-kc
./scripts/clone.sh
</pre></div>

<h3 id="deploy-order-command-microservice">Deploy Order Command microservice</h3>
<ul>
<li>Go to the repo</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> refarch-kc-order-ms/order-command-ms
</pre></div>

<ul>
<li>Build the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker build -t order-command-ms:latest -f Dockerfile.multistage .
</pre></div>

<ul>
<li>Tag the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker tag order-command-ms &lt;private-registry&gt;/&lt;image-namespace&gt;/order-command-ms:latest
</pre></div>

<ul>
<li>Push the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker login &lt;private-registry&gt;
docker push &lt;private-registry&gt;/&lt;image-namespace&gt;/order-command-ms:latest
</pre></div>

<ul>
<li>
<p>Generate application YAMLs via <code>helm template</code> with the following parameters:</p>
<ul>
<li><code>--set image.repository=&lt;private-registry&gt;/&lt;image-namespace&gt;/&lt;image-repository&gt;</code></li>
<li><code>--set image.pullSecret=&lt;private-registry-pullsecret&gt;</code> (only required if pulling from an external private registry)</li>
<li><code>--set kafka.brokersConfigMap=&lt;kafka brokers ConfigMap name&gt;</code></li>
<li><code>--set eventstreams.enabled=(true/false)</code> (<code>true</code> when connecting to Event Streams of any kind, <code>false</code> when connecting to Kafka directly)</li>
<li><code>--set eventstreams.apikeyConfigMap=&lt;kafka api key Secret name&gt;</code></li>
<li><code>--set eventstreams.truststoreRequired=(true/false)</code> (<code>true</code> when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.truststoreSecret=&lt;eventstreams jks file secret name&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.truststorePassword=&lt;eventstreams jks password&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set serviceAccountName=&lt;service-account-name&gt;</code></li>
<li><code>--namespace &lt;target-namespace&gt;</code></li>
<li><code>--output-dir &lt;local-template-directory&gt;</code>
  Example using Event Streams via ICP4I:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/order-command-ms --set kafka.brokersConfigMap<span class="o">=</span>es-kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>es-eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --set eventstreams.truststoreRequired<span class="o">=</span><span class="nb">true</span> --set eventstreams.truststoreSecret<span class="o">=</span>es-truststore-jks --set eventstreams.truststorePassword<span class="o">=</span>password --output-dir templates --namespace eda-refarch chart/ordercommandms
</pre></div>
  Example using Event Streams hosted on IBM Cloud:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/order-command-ms --set kafka.brokersConfigMap<span class="o">=</span>kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --output-dir templates --namespace eda-refarch chart/ordercommandms
</pre></div></li>
</ul>
</li>
<li>
<p>Deploy application using <code>kubectl/oc apply</code>:</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="o">(</span>kubectl/oc<span class="o">)</span> apply -f templates/ordercommandms/templates
</pre></div>

<ul>
<li>Verify default service is running correctly:</li>
</ul>
<p>Without any previously tests done, the call below should return an empty array: <code>[]</code></p>
<div class="codehilite"><pre><span></span>curl http://&lt;cluster endpoints&gt;:31200/orders
</pre></div>

<h3 id="deploy-order-query-microservice">Deploy Order Query microservice</h3>
<ul>
<li>Go to the repo</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> refarch-kc-order-ms/order-query-ms
</pre></div>

<ul>
<li>Build the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker build -t order-query-ms:latest -f Dockerfile.multistage .
</pre></div>

<ul>
<li>Tag the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker tag order-query-ms &lt;private-registry&gt;/&lt;image-namespace&gt;/order-query-ms:latest
</pre></div>

<ul>
<li>Push the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker login &lt;private-registry&gt;
docker push &lt;private-registry&gt;/&lt;image-namespace&gt;/order-query-ms:latest
</pre></div>

<ul>
<li>
<p>Generate application YAMLs via <code>helm template</code> with the following parameters:</p>
<ul>
<li><code>--set image.repository=&lt;private-registry&gt;/&lt;image-namespace&gt;/&lt;image-repository&gt;</code></li>
<li><code>--set image.pullSecret=&lt;private-registry-pullsecret&gt;</code> (only required if pulling from an external private registry)</li>
<li><code>--set kafka.brokersConfigMap=&lt;kafka brokers ConfigMap name&gt;</code></li>
<li><code>--set eventstreams.enabled=(true/false)</code> (<code>true</code> when connecting to Event Streams of any kind, <code>false</code> when connecting to Kafka directly)</li>
<li><code>--set eventstreams.apikeyConfigMap=&lt;kafka api key Secret name&gt;</code></li>
<li><code>--set eventstreams.truststoreRequired=(true/false)</code> (<code>true</code> when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.truststoreSecret=&lt;eventstreams jks file secret name&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.truststorePassword=&lt;eventstreams jks password&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set serviceAccountName=&lt;service-account-name&gt;</code></li>
<li><code>--namespace &lt;target-namespace&gt;</code></li>
<li><code>--output-dir &lt;local-template-directory&gt;</code>
  Example using Event Streams via ICP4I:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/order-query-ms --set kafka.brokersConfigMap<span class="o">=</span>es-kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>es-eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --set eventstreams.truststoreRequired<span class="o">=</span><span class="nb">true</span> --set eventstreams.truststoreSecret<span class="o">=</span>es-truststore-jks --set eventstreams.truststorePassword<span class="o">=</span>password --output-dir templates --namespace eda-refarch chart/orderqueryms
</pre></div>
  Example using Event Streams hosted on IBM Cloud:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/order-query-ms --set kafka.brokersConfigMap<span class="o">=</span>kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --output-dir templates --namespace eda-refarch chart/orderqueryms
</pre></div></li>
</ul>
</li>
<li>
<p>Deploy application using <code>kubectl/oc apply</code>:</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="o">(</span>kubectl/oc<span class="o">)</span> apply -f templates/orderqueryms/templates
</pre></div>

<ul>
<li>Verify default service is running correctly:</li>
</ul>
<p>Without any previously tests done, the call below should return an empty array: <code>[]</code>
<div class="codehilite"><pre><span></span>curl http://&lt;cluster endpoints&gt;:31100/orders
</pre></div></p>
<h3 id="deploy-container-microservice">Deploy Container microservice</h3>
<p><strong>TODO</strong> Container Microservice requires POSTGRES parameters</p>
<ul>
<li>Go to the repo</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> refarch-kc-container-ms/SpringContainerMS
</pre></div>

<ul>
<li>Build the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker build -t kc-spring-container-ms:latest -f Dockerfile .
</pre></div>

<ul>
<li>Tag the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker tag kc-spring-container-ms &lt;private-registry&gt;/&lt;image-namespace&gt;/kc-spring-container-ms:latest
</pre></div>

<ul>
<li>Push the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker login &lt;private-registry&gt;
docker push &lt;private-registry&gt;/&lt;image-namespace&gt;/kc-spring-container-ms:latest
</pre></div>

<ul>
<li>
<p>Generate application YAMLs via <code>helm template</code> with the following parameters:</p>
<ul>
<li><code>--set image.repository=&lt;private-registry&gt;/&lt;image-namespace&gt;/&lt;image-repository&gt;</code></li>
<li><code>--set image.pullSecret=&lt;private-registry-pullsecret&gt;</code> (only required if pulling from an external private registry)</li>
<li><code>--set kafka.brokersConfigMap=&lt;kafka brokers ConfigMap name&gt;</code></li>
<li><code>--set eventstreams.enabled=(true/false)</code> (<code>true</code> when connecting to Event Streams of any kind, <code>false</code> when connecting to Kafka directly)</li>
<li><code>--set eventstreams.apikeyConfigMap=&lt;kafka api key Secret name&gt;</code></li>
<li><code>--set eventstreams.caPemFileRequired=(true/false)</code> (<code>true</code> when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.caPemSecretName=&lt;eventstreams ca pem file secret name&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set postgresql.capemRequired=(true/false)</code> (<code>true</code> when connecting to Postgresql Services requiring SSL and CA PEM-secured communication)</li>
<li><code>--set postgresql.capemSecret=&lt;postgresql CA pem certificate Secret name&gt;</code></li>
<li><code>--set postgresql.urlSecret=&lt;postgresql url Secret name&gt;</code></li>
<li><code>--set postgresql.userSecret=&lt;postgresql user Secret name&gt;</code></li>
<li><code>--set postgresql.passwordSecret=&lt;postgresql password Secret name&gt;</code></li>
<li><code>--set serviceAccountName=&lt;service-account-name&gt;</code></li>
<li><code>--namespace &lt;target-namespace&gt;</code></li>
<li><code>--output-dir &lt;local-template-directory&gt;</code>
  Example using Event Streams via ICP4I:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/kc-spring-container-ms --set kafka.brokersConfigMap<span class="o">=</span>es-kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>es-eventstreams-apikey --set eventstreams.truststoreRequired<span class="o">=</span><span class="nb">true</span> --set eventstreams.truststoreSecret<span class="o">=</span>es-truststore-jks --set eventstreams.truststorePassword<span class="o">=</span>password --set postgresql.capemRequired<span class="o">=</span><span class="nb">true</span> --set postgresql.capemSecret<span class="o">=</span>postgresql-ca-pem --set postgresql.urlSecret<span class="o">=</span>postgresql-url --set postgresql.userSecret<span class="o">=</span>postgresql-user --set postgresql.passwordSecret<span class="o">=</span>postgresql-pwd --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --output-dir templates --namespace eda-refarch chart/springcontainerms
</pre></div>
  Example using Event Streams hosted on IBM Cloud:
  <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/kc-spring-container-ms --set kafka.brokersConfigMap<span class="o">=</span>es-kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>es-eventstreams-apikey --set postgresql.capemRequired<span class="o">=</span><span class="nb">true</span> --set postgresql.capemSecret<span class="o">=</span>postgresql-ca-pem --set postgresql.urlSecret<span class="o">=</span>postgresql-url --set postgresql.userSecret<span class="o">=</span>postgresql-user --set postgresql.passwordSecret<span class="o">=</span>postgresql-pwd --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --output-dir templates --namespace eda-refarch chart/springcontainerms
</pre></div></li>
</ul>
</li>
<li>
<p>Deploy application using <code>kubectl/oc apply</code>:</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="o">(</span>kubectl/oc<span class="o">)</span> apply -f templates/springcontainerms/templates
</pre></div>

<ul>
<li>Verify default service is running correctly:</li>
</ul>
<div class="codehilite"><pre><span></span>curl http://cluster-endpoints:31900/containers
</pre></div>

<h3 id="deploy-voyages-microservice">Deploy Voyages microservice</h3>
<p>The <em>Voyage microservice</em> is a simple nodejs app to mockup schedule of vessels between two harbors. It is here to illustrate Kafka integration with nodejs app.</p>
<ul>
<li>Go to the repo</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> refarch-kc-ms/voyages-ms
</pre></div>

<ul>
<li>Build the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker build -t kc-voyages-ms:latest -f Dockerfile .
</pre></div>

<ul>
<li>Tag the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker tag kc-voyages-ms &lt;private-registry&gt;/&lt;image-namespace&gt;/kc-voyages-ms:latest
</pre></div>

<ul>
<li>Push the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker login &lt;private-registry&gt;
docker push &lt;private-registry&gt;/&lt;image-namespace&gt;/kc-voyages-ms:latest
</pre></div>

<ul>
<li>
<p>Generate application YAMLs via <code>helm template</code>:</p>
<ul>
<li><code>--set image.repository=&lt;private-registry&gt;/&lt;image-namespace&gt;/&lt;image-repository&gt;</code></li>
<li><code>--set image.pullSecret=&lt;private-registry-pullsecret&gt;</code> (only required if pulling from an external private registry)</li>
<li><code>--set kafka.brokersConfigMap=&lt;kafka brokers ConfigMap name&gt;</code></li>
<li><code>--set eventstreams.enabled=(true/false)</code> (<code>true</code> when connecting to Event Streams of any kind, <code>false</code> when connecting to Kafka directly)</li>
<li><code>--set eventstreams.apikeyConfigMap=&lt;kafka api key Secret name&gt;</code></li>
<li><code>--set eventstreams.caPemFileRequired=(true/false)</code> (<code>true</code> when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.caPemSecretName=&lt;eventstreams ca pem file secret name&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set serviceAccountName=&lt;service-account-name&gt;</code></li>
<li><code>--namespace &lt;target-namespace&gt;</code></li>
<li><code>--output-dir &lt;local-template-directory&gt;</code>
  Example using Event Streams via ICP4I:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/kc-voyages-ms --set kafka.brokersConfigMap<span class="o">=</span>es-kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>es-eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --set eventstreams.caPemFileRequired<span class="o">=</span><span class="nb">true</span> --set eventstreams.caPemSecretName<span class="o">=</span>es-ca-pemfile --output-dir templates --namespace eda-refarch chart/voyagesms
</pre></div>
  Example using Event Streams hosted on IBM Cloud:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/kc-voyages-ms --set kafka.brokersConfigMap<span class="o">=</span>kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --output-dir templates --namespace eda-refarch chart/voyagesms
</pre></div></li>
</ul>
</li>
<li>
<p>Deploy application using <code>kubectl/oc apply</code>:
<div class="codehilite"><pre><span></span><span class="o">(</span>kubectl/oc<span class="o">)</span> apply -f templates/voyagesms/templates
</pre></div></p>
</li>
<li>
<p>Verify default service is running correctly:
<div class="codehilite"><pre><span></span>curl http://cluster-endpoint:31000/voyage
</pre></div></p>
</li>
</ul>
<h3 id="deploy-the-fleet-simulator-microservice">Deploy the Fleet Simulator microservice</h3>
<p>The <em>Fleet simulator</em> is to move vessels from one harbors to another, and send container metrics while the containers are on a vessel. It has some predefined simulation to trigger some events.</p>
<ul>
<li>Go to the repo</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> <span class="nb">cd</span> refarch-kc-ms/fleet-ms
</pre></div>

<ul>
<li>Build the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker build -t kc-fleet-ms:latest -f Dockerfile.multistage .
</pre></div>

<ul>
<li>Tag the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker tag kc-fleet-ms &lt;private-registry&gt;/&lt;image-namespace&gt;/kc-fleet-ms:latest
</pre></div>

<ul>
<li>Push the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker login &lt;private-registry&gt;
docker push &lt;private-registry&gt;/&lt;image-namespace&gt;/kc-fleet-ms:latest
</pre></div>

<ul>
<li>
<p>Generate application YAMLs via <code>helm template</code>:</p>
<ul>
<li><code>--set image.repository=&lt;private-registry&gt;/&lt;image-namespace&gt;/&lt;image-repository&gt;</code></li>
<li><code>--set image.pullSecret=&lt;private-registry-pullsecret&gt;</code> (only required if pulling from an external private registry)</li>
<li><code>--set kafka.brokersConfigMap=&lt;kafka brokers ConfigMap name&gt;</code></li>
<li><code>--set eventstreams.enabled=(true/false)</code> (<code>true</code> when connecting to Event Streams of any kind, <code>false</code> when connecting to Kafka directly)</li>
<li><code>--set eventstreams.apikeyConfigMap=&lt;kafka api key Secret name&gt;</code></li>
<li><code>--set eventstreams.truststoreRequired=(true/false)</code> (<code>true</code> when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.truststoreSecret=&lt;eventstreams jks file secret name&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set eventstreams.truststorePassword=&lt;eventstreams jks password&gt;</code> (only used when connecting to Event Streams via ICP4I)</li>
<li><code>--set serviceAccountName=&lt;service-account-name&gt;</code></li>
<li><code>--namespace &lt;target-namespace&gt;</code></li>
<li><code>--output-dir &lt;local-template-directory&gt;</code>
  Example using Event Streams via ICP4I:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/kc-fleet-ms --set kafka.brokersConfigMap<span class="o">=</span>es-kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>es-eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --set eventstreams.truststoreRequired<span class="o">=</span><span class="nb">true</span> --set eventstreams.truststoreSecret<span class="o">=</span>es-truststore-jks --set eventstreams.truststorePassword<span class="o">=</span>password --output-dir templates --namespace eda-refarch chart/fleetms
</pre></div>
  Example using Event Streams hosted on IBM Cloud:
   <div class="codehilite"><pre><span></span>helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/kc-fleet-ms --set kafka.brokersConfigMap<span class="o">=</span>kafka-brokers --set eventstreams.enabled<span class="o">=</span><span class="nb">true</span> --set eventstreams.apikeyConfigMap<span class="o">=</span>eventstreams-apikey --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --output-dir templates --namespace eda-refarch chart/fleetms
</pre></div></li>
</ul>
</li>
<li>
<p>Deploy application using <code>kubectl/oc apply</code>:
<div class="codehilite"><pre><span></span><span class="o">(</span>kubectl/oc<span class="o">)</span> apply -f templates/fleetms/templates
</pre></div></p>
</li>
<li>
<p>Verify default service is running correctly:</p>
</li>
</ul>
<p>At the beginning the call below should return an empty array: <code>[]</code>
<div class="codehilite"><pre><span></span>curl http://cluster-endpoint:31300/fleetms/fleets
</pre></div></p>
<h3 id="deploy-user-interface-microservice">Deploy User Interface microservice</h3>
<p><strong>TODO</strong> User Interface updates for ES ICP</p>
<ul>
<li>Go to the repo</li>
</ul>
<div class="codehilite"><pre><span></span>cd refarch-kc-ui/
</pre></div>

<ul>
<li>Build the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker build -t kcontainer-ui:latest -f Dockerfile .
</pre></div>

<ul>
<li>Tag the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker tag kc-ui &lt;private-registry&gt;/&lt;image-namespace&gt;/kcontainer-ui:latest
</pre></div>

<ul>
<li>Push the image</li>
</ul>
<div class="codehilite"><pre><span></span>docker login &lt;private-registry&gt;
docker push &lt;private-registry&gt;/&lt;image-namespace&gt;/kcontainer-ui:latest
</pre></div>

<ul>
<li>Generate application YAMLs via <code>helm template</code> with the following parameters:</li>
<li><code>--set image.repository=&lt;private-registry&gt;/&lt;image-namespace&gt;/&lt;image-repository&gt;</code></li>
<li><code>--set image.tag=latest</code></li>
<li><code>--set image.pullSecret=&lt;private-registry-pullsecret&gt;</code> (only required if pulling from an external private registry)</li>
<li><code>--set image.pullPolicy=Always</code></li>
<li><code>--set eventstreams.env=ICP</code></li>
<li><code>--set eventstreams.brokersConfigMap=&lt;kafka brokers ConfigMap name&gt;</code></li>
<li><code>--set serviceAccountName=&lt;service-account-name&gt;</code></li>
<li><code>--namespace &lt;target-namespace&gt;</code></li>
<li><code>--output-dir &lt;local-template-directory&gt;</code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># Example parameters</span>
helm template --set image.repository<span class="o">=</span>rhos-quay.internal-network.local/browncompute/kc-ui --set image.tag<span class="o">=</span>latest --set image.pullPolicy<span class="o">=</span>Always --set eventstreams.env<span class="o">=</span>ICP --set eventstreams.brokersConfigMap<span class="o">=</span>kafka-brokers --set <span class="nv">serviceAccountName</span><span class="o">=</span>kcontainer-runtime --output-dir templates --namespace eda-refarch chart/kc-ui
</pre></div>

<ul>
<li>
<p>Deploy application using <code>kubectl/oc apply</code>:
<div class="codehilite"><pre><span></span><span class="o">(</span>kubectl/oc<span class="o">)</span> apply -f templates/kc-ui/templates
</pre></div></p>
</li>
<li>
<p>Verify the installed app</p>
</li>
</ul>
<p>Point your web browser to <a href="#">http://cluster-endpoints:31010</a> and login with username: eddie@email.com and password Eddie.</p>
<h2 id="integration-tests">Integration Tests</h2>
<p>Integration tests are provided in the <a href="../../itg-tests/itgtests/">itg-tests/</a> directory and are designed to be run in-cluster with the rest of the application components.  However, they are regular Python scripts that can be adapted to be runnable anywhere, given the correct Kafka endpoints and configuration information.  For simplicity, we have created the integration tests as Kubernetes Jobs for ease of deployment and reuse.</p>
<h2 id="universal-deployment-considerations">Universal deployment considerations</h2>
<p>When deploying kafka consumer it is important to assess the horizontal pod autoscaler settings and needs, as adding consumers will not address scalability if the number of partitions in the topic(s) to consume does not match the increase of consumers. So disable HPA by default. If you want to use HPA you also need to ensure that a metrics-server is running, then set the number of partition, and the <code>hpa.maxReplicas</code> to the number of partitions.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../backing-services/" title="Backing Services" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Backing Services
              </span>
            </div>
          </a>
        
        
          <a href="../../security/" title="Security" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Security
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>